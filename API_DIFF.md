# API 版本差异对比报告 (v1.0 vs v2.0)

本报告基于 `fmo-player/api2.0` 源码与现有 `API_DOCUMENTATION.md` (基于 api1.0) 的对比分析生成。

## 1. 总体结论

**接口兼容性**: ✅ **高度兼容**
API 2.0 在接口定义（WebSocket 消息类型、参数结构、服务方法）上与 API 1.0 保持了高度一致性。现有的前端业务逻辑迁移到 2.0 版本时，绝大多数接口调用无需修改。

**主要变更点**:
1.  **音频播放体验优化**: 大幅降低了音频缓冲延迟参数。
2.  **数据验证增强**: 配置服务中增加了更严格的前端数据校验（特别是 UTF-8 字节长度限制），以匹配底层 C++ XNet 库的内存限制。

---

## 2. 详细差异对比

### 2.1 音频服务 (AudioPlayer)

| 特性 | API 1.0 (文档描述) | API 2.0 (源码实现) | 影响与说明 |
| :--- | :--- | :--- | :--- |
| **启动缓冲** | 最小 0.6 秒 | **0.1 秒** (`minStartBufferSec`) | **显著降低播放延迟**。用户点击连接后能更快听到声音。 |
| **最大缓冲** | 未明确 | **1.0 秒** (`maxBufferSec`) | 防止网络拥塞后的累积延迟，超过 1s 将丢弃旧数据。 |
| **输入采样率** | 8000 Hz | 8000 Hz | 保持一致。 |
| **DSP 处理链** | 文档提及参数 | 前端代码显式实现 | 2.0 代码中完整实现了 HPF/LPF/EQ/Compressor 逻辑，确保与文档描述一致。 |

### 2.2 配置服务 (ConfigService)

接口方法签名完全一致，主要差异在于**参数校验逻辑**的强化。

| 接口方法 | API 1.0 校验 | API 2.0 增强校验 | 业务影响 |
| :--- | :--- | :--- | :--- |
| `setAprsRemark` | 最大 63 字节 | 严格检查 UTF-8 字节数 <= 63 | 防止因多字节字符（如中文）导致后端缓冲区溢出或截断。 |
| `setServerLoginAnnouncement` | 最大 127 字节 | 严格检查 UTF-8 字节数 <= 127 + 正则过滤 | 同上，且增加了非法字符过滤。 |
| `setQsoBestWish` | 最大 64 字节 | 严格检查 UTF-8 字节数 <= 64 + 正则过滤 | 同上。 |
| `setBlacklist` | 大写字母/数字/符号 | 正则 `/^[A-Z0-9, ]*$/` | 明确了黑名单格式限制，防止非法输入。 |
| `setUrl` | 31 字符 | 增加了无空格/无斜杠/点号位置校验 | 提高了 URL 格式的合法性检查。 |

### 2.3 远程控制 (RemoteService)

| 接口 | 变更状态 | 说明 |
| :--- | :--- | :--- |
| `getList` | 无变化 | 2.0 源码中 `getList()` 依然是 `getListRange(0, 8)` 的封装，与 1.0 文档描述一致。 |
| `next` / `prev` | 无变化 | 接口保持一致。 |

### 2.4 其他服务 (Qso, WiFi, Events)

*   **QsoService**: 接口 (`getList`, `getDetail`) 完全一致。
*   **WiFiService**: 扫描与连接流程一致，超时时间 (9s/5s) 一致。
*   **EventsService**: 独立 WebSocket 通道机制一致。

---

## 3. 兼容性与迁移建议

1.  **无缝升级**: 由于接口签名未变，前端 UI 层可以直接替换引用 `api2.0` 的服务实例，无需修改调用代码。
2.  **输入验证**: 如果旧版前端允许输入超长中文字符串（虽然文档限制了字节，但可能未严格校验），在切换到 2.0 后，`ConfigService` 会在前端直接拦截并返回错误（`status: 'error'`），UI 层需确保能够处理这些验证错误反馈。
3.  **音频调试**: 由于缓冲时间大幅缩短 (0.6s -> 0.1s)，在极差网络环境下可能会出现更频繁的欠载 (under-run) 杂音，建议关注用户在弱网下的体验反馈。
