<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FMO Mobile Controller</title>
    <style>
        :root {
            /* 默认使用 Orange Theme (参考截图) */
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --accent-cyan: #ff9800;   /* 主橙色 */
            --accent-magenta: #ffb74d; /* 辅助橙色/高亮 */
            --accent-green: #4caf50;
            --border-color: #333333;
            --viz-bg: #1a1a1a;
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        /* 主题定义 - 保留其他作为可选项 */
        body.theme-cyberpunk {
            --bg-color: #050505;
            --panel-bg: rgba(20, 20, 20, 0.85);
            --text-main: #e0e0e0;
            --text-muted: #888;
            --accent-cyan: #00f3ff;
            --accent-magenta: #ff00ff;
            --accent-green: #00ff66;
            --border-color: rgba(255, 255, 255, 0.15);
            --viz-bg: radial-gradient(circle at center, #111 0%, #000 100%);
        }


        /* 主题定义 */
        body.theme-matrix {
            --bg-color: #000000;
            --panel-bg: rgba(0, 20, 0, 0.9);
            --text-main: #00ff00;
            --text-muted: #008800;
            --accent-cyan: #00ff00; /* 主色调 */
            --accent-magenta: #008f11; /* 辅色调 */
            --accent-green: #00ff00;
            --border-color: rgba(0, 255, 0, 0.2);
            --viz-bg: #000;
        }

        body.theme-ocean {
            --bg-color: #001f3f;
            --panel-bg: rgba(0, 31, 63, 0.85);
            --text-main: #b3e5fc;
            --text-muted: #568ea3;
            --accent-cyan: #7FDBFF;
            --accent-magenta: #0074D9;
            --accent-green: #39CCCC;
            --border-color: rgba(127, 219, 255, 0.2);
            --viz-bg: linear-gradient(to bottom, #001f3f, #001020);
        }

        body.theme-sunset {
            --bg-color: #2d1b2e;
            --panel-bg: rgba(45, 27, 46, 0.85);
            --text-main: #ffd1dc;
            --text-muted: #b07289;
            --accent-cyan: #ff9e64;
            --accent-magenta: #ff0055;
            --accent-green: #ffca28;
            --border-color: rgba(255, 158, 100, 0.2);
            --viz-bg: linear-gradient(to bottom, #2d1b2e, #1a0f1a);
        }

        body.theme-light {
            --bg-color: #f0f2f5;
            --panel-bg: rgba(255, 255, 255, 0.9);
            --text-main: #333333;
            --text-muted: #666666;
            --accent-cyan: #2196F3;
            --accent-magenta: #673AB7;
            --accent-green: #4CAF50;
            --border-color: rgba(0, 0, 0, 0.1);
            --viz-bg: #e0e0e0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100dvh; /* 适配移动端视口 */
            display: grid;
            grid-template-rows: auto auto 1fr auto; /* Header, Settings, Viz, Controls */
            grid-template-areas: 
                "header"
                "settings"
                "viz"
                "controls";
            overflow: hidden;
            transition: background-color 0.5s, color 0.5s;
        }

        /* 顶部状态栏 */
        header {
            grid-area: header;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            transition: background 0.5s, border-color 0.5s;
            margin: 10px 10px 0 10px;
            border-radius: var(--radius-md);
        }

        .brand {
            font-size: 1.1rem;
            font-weight: bold;
            letter-spacing: 1px;
            color: var(--accent-cyan);
            /* text-shadow: 0 0 10px rgba(0,0,0,0.1); */
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .brand::before {
            content: 'F';
            background: var(--accent-cyan);
            color: #000;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .theme-btn:active { background: rgba(255,255,255,0.1); }

        .status-indicators {
            display: flex;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #555;
            transition: all 0.3s ease;
        }
        .status-dot.connected { background-color: var(--accent-green); box-shadow: 0 0 5px var(--accent-green); }
        .status-dot.error { background-color: #ff3333; box-shadow: 0 0 5px #ff3333; }

        /* 主可视区域 */
        .viz-container {
            grid-area: viz;
            position: relative;
            background: var(--viz-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            cursor: pointer; /* 提示可点击 */
            min-height: 0; /* 防止 grid item 溢出 */
            margin: 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .viz-mode-badge {
            position: absolute;
            top: 15px;
            right: 15px; /* 移到右上角 */
            left: auto;
            transform: none;
            padding: 4px 10px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 4px;
            color: #000;
            font-weight: bold;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 1;
        }

        /* 控制面板区域 */
        .controls-area {
            grid-area: controls;
            background: var(--panel-bg);
            border-top: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: auto;
            max-height: 50vh; /* 限制最大高度，给波形留空间 */
            overflow-y: auto;
            transition: background 0.5s, border-color 0.5s;
            margin: 0 10px 10px 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        /* 播放控制 */
        /* .player-controls 移除，直接使用 control-btn-group 和 vol-bar-container 垂直排列 */

        .control-btn-group {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: space-between; /* 在小屏上分散对齐，或 center */
            width: 100%;
        }

        /* 统一大按钮样式 - 调整为矩形 */
        .btn-rect-lg {
            height: 48px; /* 加高 */
            flex: 1; /* 均匀分布 */
            min-width: 0;
            padding: 0;
            border-radius: var(--radius-sm);
            border: 1px solid var(--accent-magenta);
            background: rgba(255, 152, 0, 0.1);
            color: var(--accent-cyan);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
            box-shadow: none;
        }
        
        /* 播放按钮突出显示 */
        #btn-play {
            background: var(--accent-cyan);
            color: #000;
            border: none;
            flex: 2; /* 更宽 */
        }
        #btn-play:active { transform: scale(0.98); opacity: 0.9; }

        /* 录音按钮 */
        .btn-record {
            border-color: #d32f2f;
            color: #d32f2f;
            background: rgba(211, 47, 47, 0.1);
        }
        .btn-record.recording {
            background: #d32f2f;
            color: #fff;
            box-shadow: 0 0 10px #d32f2f;
            animation: none;
        }

        /* 顶部设置区域 */
        #settings-area {
            grid-area: settings;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            max-height: 0; /* Use max-height for transition */
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            z-index: 99;
            margin: 0 10px;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            margin-top: -10px; /* 连接 Header */
            border-top: none;
        }
        #settings-area.open {
            max-height: 300px; /* Enough space for content */
            padding: 20px;
            margin-bottom: 10px;
        }
        
        /* 历史设备列表样式 */
        .device-history {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        #settings-area.open .device-history {
            opacity: 1;
            transform: translateY(0);
        }

        .device-tag {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .device-tag:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-main);
        }
        .device-tag.active {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            background: rgba(0, 243, 255, 0.1);
        }
        .device-del {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            font-size: 10px;
            line-height: 1;
            color: #aaa;
        }
        .device-del:hover {
            background: #ff3333;
            color: white;
        }
        .btn-rect-lg:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .btn-rect-lg.active { background: var(--accent-magenta); color: var(--bg-color); box-shadow: 0 0 15px var(--accent-magenta); }

        /* 录音按钮特殊样式覆盖 */
        .btn-record {
            border-color: #ff3333;
            color: #ff3333;
        }
        .btn-record.recording {
            background: rgba(255, 51, 51, 0.2);
            box-shadow: 0 0 15px #ff3333;
            animation: pulse 1.5s infinite;
        }
        .btn-record .icon {
            width: 14px;
            height: 14px;
            background-color: currentColor;
            border-radius: 2px; /* 矩形内也是矩形 */
            transition: all 0.2s;
        }
        .btn-record.recording .icon {
            border-radius: 2px;
            transform: scale(0.8);
        }

        /* 音量条容器 */
        .vol-bar-container {
            display: flex;
            align-items: center;
            width: 100%;
            height: 48px;
            padding: 0 15px;
            box-sizing: border-box;
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .vol-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            margin-right: 15px;
            cursor: pointer;
        }
        
        .vol-track-wrapper {
            flex: 1;
            height: 48px; /* 增大触摸热区 */
            display: flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .vol-track {
            width: 100%;
            height: 6px; /* 加粗 */
            background: #333;
            border-radius: 3px;
            position: relative;
            overflow: visible;
        }

        .vol-fill {
            height: 100%;
            background: var(--accent-cyan);
            border-radius: 3px;
            width: 50%; /* 默认值 */
            position: relative;
            box-shadow: none;
            transition: width 0.1s linear;
        }

        /* 滑块头部圆点 */
        .vol-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent-cyan);
            border-radius: 50%;
            position: absolute;
            right: -9px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: transform 0.1s;
            border: 2px solid #fff;
        }
        
        .vol-track-wrapper:active .vol-thumb {
            transform: translateY(-50%) scale(1.1);
        }

        .vol-value-text {
            width: 45px;
            text-align: right;
            font-size: 14px;
            color: var(--text-muted);
            font-family: monospace;
            margin-left: 15px;
        }

        /* 台站列表 */
        .station-panel {
            background: rgba(0,0,0,0.2);
            border-radius: var(--radius-md);
            padding: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex: 1; /* 填充剩余空间 */
            min-height: 150px; /* 保证最小高度 */
            overflow: hidden;
            margin: 0 10px 10px 10px; /* 与 Controls 对齐 */
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .station-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            flex: 1;
            overflow-y: auto;
            padding-right: 2px; /* 给滚动条留点位置 */
        }

        .station-item {
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .station-item.active {
            background: rgba(0, 243, 255, 0.1);
            border-left-color: var(--accent-cyan);
        }
        .station-item:active { background: rgba(255,255,255,0.1); }
        
        .st-name { 
            font-weight: 500;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 设置面板 */
        .settings-panel {
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        .input-dark {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
        }
        .btn-small {
            padding: 0 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .btn-small:active { background: rgba(255,255,255,0.2); }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(255, 51, 51, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); }
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

        /* 工具类 */
        .hidden { display: none !important; }
        .text-cyan { color: var(--accent-cyan); }
        
        /* 平板/桌面端适配 (Landscape) */
        @media (min-width: 768px) {
            body {
                grid-template-columns: 1fr 380px;
                grid-template-rows: auto auto 1fr;
                grid-template-areas: 
                    "header header"
                    "settings settings"
                    "viz controls";
            }

            .controls-area {
                height: 100%;
                max-height: none;
                border-top: none;
                border-left: 1px solid var(--border-color);
                padding-bottom: 20px; /* 恢复正常 padding */
            }

            .viz-container {
                height: 100%;
            }
            
            /* 在宽屏下增加台站列数 */
            .station-list {
                grid-template-columns: 1fr 1fr; /* 保持2列或根据宽度调整 */
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: var(--panel-bg);
            width: 90%; max-width: 600px; max-height: 80vh;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { margin: 0; color: var(--text-main); font-size: 1.2rem; }
        .btn-icon { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0 5px; }
        .qso-list {
            flex: 1; overflow-y: auto; padding: 0;
        }
        .qso-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .qso-item:last-child { border-bottom: none; }
        .qso-info { display: flex; flex-direction: column; gap: 4px; }
        .qso-call { font-weight: bold; color: var(--text-main); font-size: 1.1rem; display: flex; align-items: center; }
        .qso-meta { font-size: 0.85rem; color: var(--text-muted); display: flex; gap: 10px; }
        .qso-freq { color: var(--accent-green); font-family: monospace; }
        .qso-mode { background: rgba(255, 152, 0, 0.2); color: var(--accent-cyan); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-left: 8px; }
        .qso-time { font-size: 0.8rem; color: #666; }
    </style>
</head>
<body>

    <header>
        <div class="brand">FMO CONTROLLER</div>
        <div class="header-right">
            <button id="btn-qso" class="theme-btn" title="QSO 日志">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            </button>
            <button id="btn-settings-toggle" class="theme-btn" title="设置">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
            <button id="btn-theme" class="theme-btn" title="切换主题">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>
            </button>
            <div class="status-indicators">
                <div id="led-ws" class="status-dot" title="控制连接"></div>
                <div id="led-audio" class="status-dot" title="音频连接"></div>
            </div>
        </div>
    </header>

    <div id="settings-area">
        <div class="input-group">
            <input type="text" id="inp-host" class="input-dark" placeholder="设备 IP 地址" value="">
            <button id="btn-connect" class="btn-small text-cyan">CONNECT</button>
        </div>
        <div id="device-history" class="device-history"></div>
    </div>

    <div class="viz-container" id="viz-area">
        <canvas id="viz-canvas"></canvas>
        <div class="viz-mode-badge" id="viz-mode-text">SPECTRUM</div>
    </div>

    <div class="controls-area">
        <!-- 播放器控制 -->
        <div class="control-btn-group">
            <button id="btn-play" class="btn-rect-lg">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button id="btn-record" class="btn-rect-lg btn-record" title="录音">
                <div class="icon"></div>
            </button>

            <button id="btn-prev" class="btn-rect-lg" title="上一台">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
            </button>
            <button id="btn-next" class="btn-rect-lg" title="下一台">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
        </div>

        <!-- 音量控制条 -->
        <div class="vol-bar-container" id="vol-container">
            <div class="vol-icon" id="vol-mute-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
            </div>
            <div class="vol-track-wrapper" id="vol-track-wrapper">
                <div class="vol-track">
                    <div class="vol-fill" id="vol-fill">
                        <div class="vol-thumb"></div>
                    </div>
                </div>
            </div>
            <div class="vol-value-text" id="vol-value-text">100%</div>
        </div>

        <!-- 台站列表 -->
        <div class="station-panel">
            <div class="station-header">
                <span>STATIONS</span>
                <span id="st-count">0/0</span>
            </div>
            <div id="st-list" class="station-list">
                <div class="station-item" style="grid-column: 1 / -1; justify-content: center; align-items: center; color: #666;">等待连接...点击顶部设置按钮设置IP</div>
            </div>

        </div>

        <!-- 设置 - 已移动到顶部，此处删除 -->
    </div>

    <!-- QSO Log Modal -->
    <div id="qso-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>QSO LOGS</h3>
                <button id="btn-qso-close" class="btn-icon">×</button>
            </div>
            <div id="qso-list" class="qso-list">
                <!-- QSO items will be injected here -->
                <div style="padding: 20px; text-align: center; color: #666;">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // --- 核心类定义区域 ---
        
        /** 音量条控制器 */
        class VolumeSlider {
            constructor(container, player) {
                this.container = container;
                this.player = player;
                this.trackWrapper = container.querySelector('#vol-track-wrapper');
                this.fill = container.querySelector('#vol-fill');
                this.text = container.querySelector('#vol-value-text');
                this.muteBtn = container.querySelector('#vol-mute-btn');
                
                this.isDragging = false;
                this.value = 1.0; // 0.0 - 1.0
                
                this.initEvents();
                this.updateUI(this.value);
            }

            initEvents() {
                // 点击或拖动处理
                const updateFromEvent = (e) => {
                    const rect = this.trackWrapper.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    let percent = (clientX - rect.left) / rect.width;
                    percent = Math.max(0, Math.min(1, percent));
                    
                    this.setVolume(percent);
                };

                // 鼠标事件
                this.trackWrapper.addEventListener('mousedown', (e) => {
                    this.isDragging = true;
                    updateFromEvent(e);
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });

                const onMove = (e) => {
                    if (this.isDragging) {
                        updateFromEvent(e);
                        e.preventDefault();
                    }
                };

                const onUp = () => {
                    this.isDragging = false;
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                };

                // 触摸事件
                this.trackWrapper.addEventListener('touchstart', (e) => {
                    this.isDragging = true;
                    updateFromEvent(e);
                    document.addEventListener('touchmove', onTouchMove, { passive: false });
                    document.addEventListener('touchend', onTouchEnd);
                });

                const onTouchMove = (e) => {
                    if (this.isDragging) {
                        updateFromEvent(e);
                        e.preventDefault();
                    }
                };

                const onTouchEnd = () => {
                    this.isDragging = false;
                    document.removeEventListener('touchmove', onTouchMove);
                    document.removeEventListener('touchend', onTouchEnd);
                };

                // 静音切换
                this.muteBtn.addEventListener('click', () => {
                    if (this.value > 0) {
                        this.lastValue = this.value;
                        this.setVolume(0);
                    } else {
                        this.setVolume(this.lastValue || 0.5);
                    }
                    // 震动
                    if (navigator.vibrate) navigator.vibrate(10);
                });
            }

            setVolume(val) {
                this.value = val;
                this.player.setVolume(val); // 假设 player 支持 0-1
                this.updateUI(val);
            }

            updateUI(val) {
                const percent = Math.round(val * 100);
                this.fill.style.width = `${percent}%`;
                this.text.textContent = `${percent}%`;
                
                // 更新图标状态
                if (val === 0) {
                    this.muteBtn.style.opacity = '0.5';
                    this.muteBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`;
                } else {
                    this.muteBtn.style.opacity = '1';
                    this.muteBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>`;
                }
            }
        }

        /** 基础事件发射器 */
        class EventEmitter {
            constructor() { this.events = {}; }
            on(event, listener) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(listener);
            }
            emit(event, ...args) {
                if (this.events[event]) this.events[event].forEach(fn => fn(...args));
            }
        }

        /** WebSocket 控制客户端 */
        class ControlClient extends EventEmitter {
            constructor() {
                super();
                this.ws = null;
                this.connected = false;
                this.reconnectTimer = null;
                this.autoUpdateTimer = null; // 自动更新定时器
                this.host = '';
            }

            connect(host) {
                this.host = host;
                if (this.ws) {
                    // 关闭旧连接前清除定时器
                    if (this.autoUpdateTimer) {
                        clearInterval(this.autoUpdateTimer);
                        this.autoUpdateTimer = null;
                    }
                    this.ws.close();
                    this.ws = null;
                }

                try {
                    this.ws = new WebSocket(`ws://${this.host}/ws`);
                    
                    this.ws.onopen = () => {
                        this.connected = true;
                        this.emit('status', true);
                        // 连接后自动获取列表和当前台站
                        const fetchList = () => {
                            this.send('station', 'getListRange', { start: 0, count: 20 });
                        };
                        fetchList();
                        this.send('station', 'getCurrent');

                        // 开启10秒自动更新
                        if (this.autoUpdateTimer) clearInterval(this.autoUpdateTimer);
                        this.autoUpdateTimer = setInterval(fetchList, 10000);
                    };

                    this.ws.onclose = () => {
                        this.connected = false;
                        this.emit('status', false);
                        
                        // 清除自动更新
                        if (this.autoUpdateTimer) {
                            clearInterval(this.autoUpdateTimer);
                            this.autoUpdateTimer = null;
                        }

                        // 3秒后重连
                        clearTimeout(this.reconnectTimer);
                        this.reconnectTimer = setTimeout(() => this.connect(this.host), 3000);
                    };

                    this.ws.onerror = (e) => {
                        console.error('WS Error:', e);
                        this.connected = false;
                        this.emit('status', false);
                    };

                    this.ws.onmessage = (e) => {
                        try {
                            const msg = JSON.parse(e.data);
                            this.handleMessage(msg);
                        } catch (err) {
                            console.error('Parse Error:', err);
                        }
                    };

                } catch (e) {
                    console.error('Connection Failed:', e);
                    this.emit('status', false);
                }
            }

            send(type, subType, data = {}) {
                if (!this.connected || !this.ws) return;
                this.ws.send(JSON.stringify({ type, subType, data }));
            }

            handleMessage(msg) {
                // 路由不同类型的消息
                if (msg.type === 'station') {
                    switch (msg.subType) {
                        case 'getListResponse':
                            this.emit('stationList', msg.data.list || []);
                            break;
                        case 'getCurrentResponse':
                            this.emit('stationCurrent', msg.data);
                            break;
                        case 'setCurrentResponse':
                            // 操作结果，可加 Toast
                            break;
                    }
                } else if (msg.type === 'qso') {
                    this.emit('qsoMessage', msg);
                }
            }

            // 快捷指令
            setStation(uid) { this.send('station', 'setCurrent', { uid }); }
            nextStation() { this.send('station', 'next'); }
            prevStation() { this.send('station', 'prev'); }
            
            // QSO 指令
            getQsoList(page = 0, pageSize = 20) {
                this.send('qso', 'getList', { page, pageSize });
            }
        }

        /** 音频播放器 (PCM 流处理) */
        class AudioPlayer extends EventEmitter {
            constructor() {
                super();
                this.audioCtx = null;
                this.ws = null;
                this.connected = false;
                this.analyser = null;
                this.gainNode = null;
                
                // 缓冲调度相关
                this.chunkQueue = [];
                this.scheduledEndTime = 0;
                this.started = false;
                this.buffering = true;
                
                // 音频参数
                this.sampleRate = 8000;
                this.targetLead = 0.5; // 目标领先时间(s)

                // 录音相关
                this.recording = false;
                this.recordedChunks = [];
            }

            async ensureAudioContext() {
                if (!this.audioCtx) {
                    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioCtx.createAnalyser();
                    this.analyser.fftSize = 2048; // 高分辨率
                    this.analyser.smoothingTimeConstant = 0.8;
                    
                    this.gainNode = this.audioCtx.createGain();
                    this.gainNode.gain.value = 1.0;

                    // 连线: Source -> Gain -> Analyser -> Dest
                    this.gainNode.connect(this.analyser);
                    this.analyser.connect(this.audioCtx.destination);
                }
                if (this.audioCtx.state === 'suspended') {
                    await this.audioCtx.resume();
                }
            }

            connect(host) {
                if (this.connected) return;
                this.ensureAudioContext();
                
                // 重置状态
                this.chunkQueue = [];
                this.scheduledEndTime = this.audioCtx.currentTime;
                this.started = false;
                this.buffering = true;

                try {
                    this.ws = new WebSocket(`ws://${host}/audio`);
                    this.ws.binaryType = 'arraybuffer';

                    this.ws.onopen = () => {
                        this.connected = true;
                        this.emit('status', true);
                    };

                    this.ws.onclose = () => {
                        this.connected = false;
                        this.emit('status', false);
                    };

                    this.ws.onmessage = (e) => {
                        if (e.data instanceof ArrayBuffer) {
                            this.handlePCM(e.data);
                        }
                    };
                } catch (e) {
                    console.error('Audio Connect Failed:', e);
                }
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                this.connected = false;
                this.emit('status', false);
            }

            handlePCM(buffer) {
                // 录音收集
                if (this.recording) {
                    this.recordedChunks.push(buffer.slice(0));
                }

                // PCM16 -> Float32
                const int16 = new Int16Array(buffer);
                const float32 = new Float32Array(int16.length);
                for (let i = 0; i < int16.length; i++) {
                    float32[i] = int16[i] / 32768;
                }
                
                this.chunkQueue.push(float32);
                this.schedule();
            }

            startRecording() {
                this.recording = true;
                this.recordedChunks = [];
            }

            stopRecording() {
                this.recording = false;
                const blob = this.exportWAV();
                this.recordedChunks = [];
                return blob;
            }

            exportWAV() {
                if (this.recordedChunks.length === 0) return null;
                // 计算总长度
                const totalLen = this.recordedChunks.reduce((acc, c) => acc + c.byteLength, 0);
                const buffer = new Uint8Array(totalLen);
                let offset = 0;
                for (const chunk of this.recordedChunks) {
                    buffer.set(new Uint8Array(chunk), offset);
                    offset += chunk.byteLength;
                }
                
                // 创建 WAV 头
                const wavHeader = this.createWavHeader(totalLen, 1, this.sampleRate, 16);
                return new Blob([wavHeader, buffer], { type: 'audio/wav' });
            }

            createWavHeader(dataLength, numChannels, sampleRate, bitsPerSample) {
                const header = new ArrayBuffer(44);
                const view = new DataView(header);
                
                // RIFF chunk descriptor
                this.writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataLength, true);
                this.writeString(view, 8, 'WAVE');
                
                // fmt sub-chunk
                this.writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
                view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * numChannels * bitsPerSample / 8, true); // ByteRate
                view.setUint16(32, numChannels * bitsPerSample / 8, true); // BlockAlign
                view.setUint16(34, bitsPerSample, true);
                
                // data sub-chunk
                this.writeString(view, 36, 'data');
                view.setUint32(40, dataLength, true);
                
                return header;
            }
            
            writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            schedule() {
                if (!this.audioCtx) return;
                const now = this.audioCtx.currentTime;
                if (this.scheduledEndTime < now) this.scheduledEndTime = now;

                // 简单的缓冲策略
                if (this.buffering) {
                    // 积攒约 0.5s 数据再开始
                    const totalSamples = this.chunkQueue.reduce((acc, c) => acc + c.length, 0);
                    if (totalSamples / this.sampleRate > 0.5) {
                        this.buffering = false;
                        this.started = true;
                    } else {
                        return;
                    }
                }

                // 调度所有队列中的块
                while (this.chunkQueue.length) {
                    const chunk = this.chunkQueue.shift();
                    const buffer = this.audioCtx.createBuffer(1, chunk.length, this.sampleRate);
                    buffer.copyToChannel(chunk, 0);

                    const source = this.audioCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(this.gainNode);
                    source.start(this.scheduledEndTime);

                    this.scheduledEndTime += chunk.length / this.sampleRate;
                }
            }

            setVolume(val) {
                if (this.gainNode) this.gainNode.gain.value = val;
            }
        }

        /** 可视化引擎 */
        class Visualizer {
            constructor(canvas, analyser) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.analyser = analyser;
                this.mode = 0; 
                this.modes = ['SPECTRUM', 'MIRROR', 'WAVEFORM', 'OSCILLOSCOPE', 'RADIAL', 'PARTICLES'];
                this.running = false;
                
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = this.canvas.clientWidth * window.devicePixelRatio;
                this.canvas.height = this.canvas.clientHeight * window.devicePixelRatio;
            }

            setAnalyser(analyser) { this.analyser = analyser; }

            switchMode() {
                this.mode = (this.mode + 1) % this.modes.length;
                return this.modes[this.mode];
            }

            start() {
                if (this.running) return;
                this.running = true;
                this.loop();
            }

            loop() {
                if (!this.running) return;
                requestAnimationFrame(() => this.loop());
                
                const w = this.canvas.width;
                const h = this.canvas.height;
                
                // 获取当前主题颜色
                const styles = getComputedStyle(document.body);
                const colorCyan = styles.getPropertyValue('--accent-cyan').trim() || '#00f3ff';
                const colorMagenta = styles.getPropertyValue('--accent-magenta').trim() || '#ff00ff';
                const colorGreen = styles.getPropertyValue('--accent-green').trim() || '#00ff66';

                this.ctx.clearRect(0, 0, w, h);

                if (!this.analyser) return;

                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const modeName = this.modes[this.mode];

                if (modeName === 'SPECTRUM') { 
                    this.analyser.getByteFrequencyData(dataArray);
                    const barWidth = (w / bufferLength) * 2.5;
                    let x = 0;
                    for(let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * h;
                        const hue = (i / bufferLength * 360) + 180; 
                        this.ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                        this.ctx.fillRect(x, h - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }
                }
                else if (modeName === 'MIRROR') {
                    this.analyser.getByteFrequencyData(dataArray);
                    const barWidth = (w / bufferLength) * 2;
                    const cx = w / 2;
                    for(let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * (h / 2);
                        this.ctx.fillStyle = colorCyan;
                        // 左右对称
                        this.ctx.fillRect(cx + i * (barWidth + 1), (h/2) - (barHeight/2), barWidth, barHeight);
                        this.ctx.fillRect(cx - i * (barWidth + 1), (h/2) - (barHeight/2), barWidth, barHeight);
                    }
                }
                else if (modeName === 'WAVEFORM') {
                    this.analyser.getByteTimeDomainData(dataArray);
                    this.ctx.lineWidth = 3;
                    this.ctx.strokeStyle = colorCyan;
                    this.ctx.beginPath();
                    const sliceWidth = w * 1.0 / bufferLength;
                    let x = 0;
                    for(let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * h/2 * 1.25;
                        if(i === 0) this.ctx.moveTo(x, y);
                        else this.ctx.lineTo(x, y);
                        x += sliceWidth;
                    }
                    this.ctx.lineTo(w, h/2);
                    this.ctx.stroke();
                }
                else if (modeName === 'OSCILLOSCOPE') {
                    this.analyser.getByteTimeDomainData(dataArray);
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = colorGreen;
                    this.ctx.shadowBlur = 10;
                    this.ctx.shadowColor = colorGreen;
                    this.ctx.beginPath();
                    
                    const sliceWidth = w * 1.0 / bufferLength;
                    let x = 0;
                    for(let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * h/2 * 1.25;
                        if(i === 0) this.ctx.moveTo(x, y);
                        else this.ctx.lineTo(x, y);
                        x += sliceWidth;
                    }
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0; // reset
                    
                    // 网格线
                    this.ctx.strokeStyle = 'rgba(255,255,255,0.1)';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, h/2); this.ctx.lineTo(w, h/2);
                    this.ctx.moveTo(w/2, 0); this.ctx.lineTo(w/2, h);
                    this.ctx.stroke();
                }
                else if (modeName === 'RADIAL') { 
                    this.analyser.getByteFrequencyData(dataArray);
                    const cx = w / 2;
                    const cy = h / 2;
                    const radius = Math.min(w, h) / 3;
                    
                    this.ctx.lineWidth = 2;
                    this.ctx.strokeStyle = colorMagenta;
                    this.ctx.beginPath();
                    
                    for(let i = 0; i < bufferLength; i+=4) { 
                        const v = dataArray[i];
                        const angle = (i / bufferLength) * Math.PI * 2;
                        const r = radius + (v / 255) * 100;
                        const x = cx + Math.cos(angle) * r;
                        const y = cy + Math.sin(angle) * r;
                        if (i === 0) this.ctx.moveTo(x, y);
                        else this.ctx.lineTo(x, y);
                    }
                    this.ctx.closePath();
                    this.ctx.stroke();
                    
                    // 中心发光圆
                    this.ctx.beginPath();
                    this.ctx.arc(cx, cy, radius * 0.8, 0, Math.PI * 2);
                    this.ctx.fillStyle = colorCyan + '33'; // add transparency
                    this.ctx.fill();
                }
                else if (modeName === 'PARTICLES') {
                    this.analyser.getByteFrequencyData(dataArray);
                    // 简单粒子：取低频部分控制大小
                    const bass = dataArray[10] / 255.0;
                    const cx = w / 2;
                    const cy = h / 2;
                    
                    // 随机散布点
                    const count = 50;
                    for(let i=0; i<count; i++) {
                        const angle = (i/count) * Math.PI * 2 + (Date.now() * 0.001);
                        const dist = Math.min(w,h)/4 + bass * 100;
                        const x = cx + Math.cos(angle) * dist;
                        const y = cy + Math.sin(angle) * dist;
                        
                        this.ctx.beginPath();
                        this.ctx.arc(x, y, 2 + bass*5, 0, Math.PI*2);
                        this.ctx.fillStyle = i % 2 ? colorCyan : colorMagenta;
                        this.ctx.fill();
                    }
                }
            }
        }

        /** 设备历史管理 */
        class DeviceManager {
            constructor() {
                this.devices = [];
                this.storageKey = 'fmo_saved_devices';
                this.load();
            }

            load() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    this.devices = saved ? JSON.parse(saved) : [];
                } catch (e) {
                    this.devices = [];
                }
            }

            save() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.devices));
                this.render();
            }

            add(ip) {
                if (!ip) return;
                // 移除已存在的（为了置顶）
                this.devices = this.devices.filter(d => d !== ip);
                // 添加到头部
                this.devices.unshift(ip);
                // 限制数量
                if (this.devices.length > 5) this.devices.pop();
                this.save();
            }

            remove(ip, e) {
                if (e) {
                    e.stopPropagation();
                    e.preventDefault();
                }
                this.devices = this.devices.filter(d => d !== ip);
                this.save();
            }

            render() {
                const container = document.getElementById('device-history');
                if (!container) return;
                container.innerHTML = '';
                
                const currentIp = document.getElementById('inp-host').value;

                this.devices.forEach(ip => {
                    const tag = document.createElement('div');
                    tag.className = 'device-tag';
                    if (currentIp === ip) tag.classList.add('active');
                    
                    tag.innerHTML = `
                        ${ip}
                        <span class="device-del" title="删除">✕</span>
                    `;
                    
                    tag.onclick = () => {
                        document.getElementById('inp-host').value = ip;
                        this.render(); // 更新高亮
                        // 触发连接
                        document.getElementById('btn-connect').click();
                    };
                    
                    const delBtn = tag.querySelector('.device-del');
                    delBtn.onclick = (e) => this.remove(ip, e);
                    
                    container.appendChild(tag);
                });
            }
        }

        /** QSO 日志管理器 */
        class QsoManager {
            constructor(client) {
                this.client = client;
                this.modal = document.getElementById('qso-modal');
                this.listEl = document.getElementById('qso-list');
                this.btn = document.getElementById('btn-qso');
                this.btnClose = document.getElementById('btn-qso-close');
                
                this.page = 0;
                this.pageSize = 20; // Default page size
                this.isLoading = false;

                if (this.btn && this.modal) {
                    this.initEvents();
                }
            }

            initEvents() {
                // Open Modal
                this.btn.addEventListener('click', () => {
                    this.show();
                });

                // Close Modal
                this.btnClose.addEventListener('click', () => {
                    this.hide();
                });
                
                // Close on backdrop click
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.hide();
                });

                // Handle WS messages
                this.client.on('qsoMessage', (msg) => {
                    if (msg.subType === 'getListResponse') {
                        this.renderList(msg.data.list || []);
                    }
                });
            }

            show() {
                this.modal.classList.add('show');
                this.fetchData();
            }

            hide() {
                this.modal.classList.remove('show');
            }

            fetchData() {
                this.listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading...</div>';
                this.client.getQsoList(this.page, this.pageSize);
            }

            formatDate(ts) {
                if (!ts) return '-';
                const d = new Date(ts * 1000);
                const pad = (n) => String(n).padStart(2, '0');
                return `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }

            renderList(list) {
                if (!list || list.length === 0) {
                    this.listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No QSO logs found.</div>';
                    return;
                }

                this.listEl.innerHTML = list.map(item => {
                    const call = item.toCallsign || 'UNKNOWN';
                    const grid = item.grid || '-';
                    const time = this.formatDate(item.timestamp);
                    // item.freqHz unit is uncertain, assuming Hz and converting to MHz
                    const freq = item.freqHz ? (item.freqHz / 1000000).toFixed(4) + ' MHz' : ''; 
                    
                    return `
                    <div class="qso-item">
                        <div class="qso-info">
                            <div class="qso-call">
                                ${call}
                                <span class="qso-mode">${grid}</span>
                            </div>
                            <div class="qso-meta">
                                ${freq ? `<span class="qso-freq">${freq}</span>` : ''}
                                <span class="qso-time">${time}</span>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }
        }

        // 预设 Host
        document.getElementById('inp-host').value = window.location.hostname || '192.168.43.18';

        // --- 应用逻辑 ---
        const ctrl = new ControlClient();
        const player = new AudioPlayer();
        const viz = new Visualizer(document.getElementById('viz-canvas'), null);
        const deviceMgr = new DeviceManager();
        const qsoMgr = new QsoManager(ctrl); // Add QSO Manager
        
        const ui = {
            ledWs: document.getElementById('led-ws'),
            ledAudio: document.getElementById('led-audio'),
            btnTheme: document.getElementById('btn-theme'),
            btnSettingsToggle: document.getElementById('btn-settings-toggle'),
            settingsArea: document.getElementById('settings-area'),
            btnPlay: document.getElementById('btn-play'),
            // volKnob/volValue removed (using VolumeSlider)
            btnRecord: document.getElementById('btn-record'),
            vizArea: document.getElementById('viz-area'),
            vizModeText: document.getElementById('viz-mode-text'),
            stCount: document.getElementById('st-count'),
            stList: document.getElementById('st-list'),
            btnPrev: document.getElementById('btn-prev'),
            btnNext: document.getElementById('btn-next'),
            inpHost: document.getElementById('inp-host'),
            btnConnect: document.getElementById('btn-connect'),
        };

        let currentStationId = null;
        
        // 0. 主题切换
        const themes = ['', 'theme-matrix', 'theme-ocean', 'theme-sunset', 'theme-light'];
        let currentThemeIndex = 0;
        
        ui.btnTheme.addEventListener('click', () => {
            if (themes[currentThemeIndex]) {
                document.body.classList.remove(themes[currentThemeIndex]);
            }
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            if (themes[currentThemeIndex]) {
                document.body.classList.add(themes[currentThemeIndex]);
            }
        });

        // 0.1 设置开关
        ui.btnSettingsToggle.addEventListener('click', () => {
            ui.settingsArea.classList.toggle('open');
        });

        // 1. 连接逻辑
        ui.btnConnect.addEventListener('click', () => {
            const host = ui.inpHost.value.trim();
            if (!host) return;
            ctrl.connect(host);
            player.connect(host);
            viz.start();
            deviceMgr.add(host);
        });

        ctrl.on('status', (connected) => {
            ui.ledWs.className = `status-dot ${connected ? 'connected' : 'error'}`;
            if (connected) {
                ui.btnConnect.textContent = '已连接';
                ui.btnConnect.style.color = 'var(--accent-green)';
            } else {
                ui.btnConnect.textContent = 'CONNECT';
                ui.btnConnect.style.color = 'var(--accent-cyan)';
            }
        });

        player.on('status', (connected) => {
            ui.ledAudio.className = `status-dot ${connected ? 'connected' : 'error'}`;
            // 音频连接后，将分析节点交给可视化引擎
            if (connected && player.analyser) {
                viz.setAnalyser(player.analyser);
            }
        });

        // 2. 播放控制
        ui.btnPlay.addEventListener('click', () => {
            const host = ui.inpHost.value.trim();
            if (!player.connected) {
                player.connect(host);
            } else {
                // 仅作为重连或断开开关
                player.disconnect();
            }
        });
        
        // 监听音频连接状态改变按钮样式
        player.on('status', (connected) => {
            if (connected) {
                ui.btnPlay.classList.add('active');
                ui.btnPlay.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
            } else {
                ui.btnPlay.classList.remove('active');
                ui.btnPlay.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            }
        });

        // 音量条初始化
        const volContainer = document.getElementById('vol-container');
        const volSlider = new VolumeSlider(volContainer, player);

        // 3. 可视化切换
        ui.vizArea.addEventListener('click', () => {
            const modeName = viz.switchMode();
            ui.vizModeText.textContent = modeName;
        });

        // 5. 录音控制
        ui.btnRecord.addEventListener('click', () => {
            if (!player.recording) {
                // 开始录音
                if (!player.connected) {
                    alert('请先连接音频！');
                    return;
                }
                player.startRecording();
                ui.btnRecord.classList.add('recording');
            } else {
                // 停止录音并下载
                ui.btnRecord.classList.remove('recording');
                const blob = player.stopRecording();
                if (blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    // 文件名：fmo_rec_时间戳.wav
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    a.download = `fmo_rec_${timestamp}.wav`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                } else {
                    alert('录音时长太短或无数据');
                }
            }
        });

        // 4. 台站列表逻辑
        ctrl.on('stationList', (list) => {
            ui.stCount.textContent = `${list.length} STATIONS`;
            ui.stList.innerHTML = '';
            
            if (list.length === 0) {
                ui.stList.innerHTML = '<div class="station-item" style="grid-column: 1 / -1; justify-content: center; align-items: center; color: #666;">暂无台站</div>';
                return;
            }

            list.forEach(st => {
                const el = document.createElement('div');
                el.className = 'station-item';
                el.dataset.uid = st.uid;
                if (st.uid == currentStationId) el.classList.add('active');
                
                el.innerHTML = `
                    <div class="st-name">${st.name || 'Station ' + st.uid}</div>
                `;
                el.onclick = () => {
                    ctrl.setStation(st.uid);
                    // 乐观更新 UI
                    document.querySelectorAll('.station-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                    currentStationId = st.uid;
                };
                ui.stList.appendChild(el);
            });
        });

        ctrl.on('stationCurrent', (data) => {
            currentStationId = data.uid;
            // 高亮当前
            const items = document.querySelectorAll('.station-item');
            items.forEach(el => {
                if (el.dataset.uid == currentStationId) el.classList.add('active');
                else el.classList.remove('active');
            });
        });

        ui.btnPrev.addEventListener('click', () => ctrl.prevStation());
        ui.btnNext.addEventListener('click', () => ctrl.nextStation());

        // 初始化设备列表
        deviceMgr.render();

    </script>


</body>
</html>