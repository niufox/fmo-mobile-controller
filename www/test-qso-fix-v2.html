<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSOæ˜Ÿæ˜Ÿç»Ÿè®¡ä¿®å¤ - é€»è¾‘ä¿®æ­£ç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
        }
        h1 {
            text-align: center;
            color: #e94560;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(22, 33, 62, 0.8);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #0f3460;
        }
        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #4ade80;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4ade80;
        }
        .code-block {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
        }
        .highlight {
            color: #e94560;
            font-weight: bold;
        }
        .success {
            color: #4ade80;
        }
        .info {
            color: #60a5fa;
        }
        .demo-panel {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }
        .badge-demo {
            flex: 1;
            background: rgba(233, 69, 96, 0.1);
            padding: 20px;
            border-radius: 8px;
        }
        .badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid #0f3460;
            margin-bottom: 15px;
        }
        .badge-icon {
            width: 16px;
            height: 16px;
        }
        .badge-count {
            font-size: 1.5em;
            font-weight: bold;
        }
        button {
            background: #0f3460;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #e94560;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .log-output {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .log-time {
            color: #888;
            margin-right: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #0f3460;
        }
        th {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸŒŸ QSOæ˜Ÿæ˜Ÿç»Ÿè®¡ä¿®å¤ - é€»è¾‘ä¿®æ­£ç‰ˆ</h1>

    <div class="test-section">
        <div class="section-title">æ ¸å¿ƒä¿®å¤</div>
        <table>
            <thead>
                <tr>
                    <th>é—®é¢˜</th>
                    <th>ä¿®å¤å‰</th>
                    <th>ä¿®å¤å</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>é‡å¤ç´¯åŠ </strong></td>
                    <td>æ¯ä¸ªå“åº”éƒ½ç´¯åŠ æ€»æ•°</td>
                    <td><span class="success">åªåœ¨å…¨é‡è·å–æ—¶ç´¯åŠ </span></td>
                </tr>
                <tr>
                    <td><strong>é‡å¤è¯·æ±‚</strong></td>
                    <td>æ¯æ¬¡æ‰“å¼€éƒ½è¯·æ±‚ç¬¬ä¸€é¡µ</td>
                    <td><span class="success">ä½¿ç”¨ç¼“å­˜æ•°æ®</span></td>
                </tr>
                <tr>
                    <td><strong>äº‹ä»¶ç›‘å¬</strong></td>
                    <td>æ¯æ¬¡éƒ½æ·»åŠ æ–°ç›‘å¬å™¨</td>
                    <td><span class="success">ç»Ÿä¸€åœ¨initEventsä¸­å¤„ç†</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <div class="section-title">æ–°å¢å±æ€§</div>
        <div class="code-block">
<span class="info">// åœ¨æ„é€ å‡½æ•°ä¸­æ–°å¢</span><br>
this.totalQsoCount = 0;      <span class="success">// ç´¯è®¡æ€»æ•°</span><br>
this.currentPage = 0;           <span class="success">// å½“å‰é¡µç </span><br>
this.isFetchingAll = false;     <span class="success">// æ˜¯å¦æ­£åœ¨å…¨é‡è·å–</span><br>
this.qsoList = [];            <span class="success">// ç¼“å­˜æ‰€æœ‰QSOè®°å½•</span><br>
this.lastFetchPage = -1;       <span class="highlight">// è®°å½•æœ€åä¸€æ¬¡è¯·æ±‚çš„é¡µç </span>
        </div>
    </div>

    <div class="test-section">
        <div class="section-title">fetchAllQsoPages ç®€åŒ–</div>
        <div class="code-block">
<span class="success">// ä¿®æ”¹å‰ï¼šåŒ…å«äº‹ä»¶ç›‘å¬å™¨ï¼Œé‡å¤æ·»åŠ </span><br>
fetchAllQsoPages() {<br>
&nbsp;&nbsp;const handleQsoResponse = (msg) => { ... };<br>
&nbsp;&nbsp;this.client.on('qsoMessage', handleQsoResponse);  <span class="highlight">// é‡å¤ï¼</span><br>
}<br><br>
<span class="success">// ä¿®æ”¹åï¼šåªå‘èµ·è¯·æ±‚ï¼Œäº‹ä»¶å¤„ç†ç»Ÿä¸€åœ¨initEvents</span><br>
fetchAllQsoPages() {<br>
&nbsp;&nbsp;this.isFetchingAll = true;<br>
&nbsp;&nbsp;this.lastFetchPage = this.currentPage;  <span class="highlight">// è®°å½•é¡µç </span><br>
&nbsp;&nbsp;this.client.getQsoList(this.currentPage, this.pageSize);<br>
}
        </div>
    </div>

    <div class="test-section">
        <div class="section-title">äº‹ä»¶å¤„ç†ç»Ÿä¸€</div>
        <div class="code-block">
<span class="info">// initEventsä¸­çš„äº‹ä»¶å¤„ç†å™¨</span><br>
this.client.on('qsoMessage', (msg) => {<br>
&nbsp;&nbsp;if (msg.subType === 'getListResponse') {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="info">// åˆ†ä¸¤ç§æƒ…å†µå¤„ç†</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;if (this.isFetchingAll) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="success">// å…¨é‡è·å–æ¨¡å¼</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.totalQsoCount += list.length;  <span class="highlight">// ç´¯åŠ </span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.updateCount(this.totalQsoCount);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// åˆ¤æ–­æ˜¯å¦ç»§ç»­...<br>
&nbsp;&nbsp;&nbsp;&nbsp;} else {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="success">// å•æ¬¡è¯·æ±‚æ¨¡å¼</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.renderList(list);  <span class="highlight">// åªæ˜¾ç¤ºï¼Œä¸ç´¯åŠ </span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// å‘é€åˆ°åœ°å›¾...<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;}<br>
});
        </div>
    </div>

    <div class="test-section">
        <div class="section-title">show() æ–¹æ³•ä¼˜åŒ–</div>
        <div class="code-block">
<span class="highlight">// ä¿®æ”¹å‰ï¼šæ¯æ¬¡æ‰“å¼€éƒ½è¯·æ±‚</span><br>
show() {<br>
&nbsp;&nbsp;this.modal.classList.add('show');<br>
&nbsp;&nbsp;this.fetchData(true, true);  <span class="highlight">// æ¯æ¬¡éƒ½è¯·æ±‚ï¼</span><br>
}<br><br>
<span class="success">// ä¿®æ”¹åï¼šä½¿ç”¨ç¼“å­˜æ•°æ®</span><br>
show() {<br>
&nbsp;&nbsp;this.modal.classList.add('show');<br>
<br>
&nbsp;&nbsp;<span class="info">// å¦‚æœå·²æœ‰ç¼“å­˜æ•°æ®ï¼Œç›´æ¥æ˜¾ç¤º</span><br>
&nbsp;&nbsp;if (this.qsoList && this.qsoList.length > 0) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;this.renderList(this.qsoList);  <span class="highlight">// ä¸è¯·æ±‚ï¼</span><br>
&nbsp;&nbsp;} else if (!this.isFetchingAll) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;this.fetchAllQsoPages();  <span class="highlight">// åªåœ¨æ— æ•°æ®æ—¶å¯åŠ¨</span><br>
&nbsp;&nbsp;}<br>
}
        </div>
    </div>

    <div class="test-section">
        <div class="section-title">äº¤äº’æ¼”ç¤º</div>
        <div class="demo-panel">
            <div class="badge-demo">
                <div style="font-weight: bold; margin-bottom: 10px;">æ˜Ÿæ˜Ÿå¾½ç« </div>
                <div class="badge">
                    <svg class="badge-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <span class="badge-count" id="badge-count">0</span>
                </div>
                <div style="font-size: 0.85em; color: #888; margin-top: 10px;">
                    æ˜¾ç¤ºå½“å‰QSOæ€»æ•°
                </div>
            </div>
            <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 15px;">æ¨¡æ‹Ÿæ“ä½œ</div>
                <button onclick="simulateConnect()" id="btn-connect">
                    ğŸ“¡ æ¨¡æ‹Ÿè¿æ¥
                </button>
                <button onclick="simulateClickBadge()" id="btn-click">
                    ğŸŒŸ ç‚¹å‡»æ˜Ÿæ˜Ÿ
                </button>
                <button onclick="simulateRefresh()" id="btn-refresh">
                    ğŸ”„ æ¨¡æ‹Ÿåˆ·æ–°
                </button>
                <button onclick="simulateReset()" id="btn-reset">
                    ğŸ—‘ï¸ é‡ç½®çŠ¶æ€
                </button>
            </div>
        </div>
        <div class="log-output" id="log-output">
            <div class="log-item" style="color: #888;">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <div class="test-section">
        <div class="section-title">é¢„æœŸè¡Œä¸º</div>
        <table>
            <thead>
                <tr>
                    <th>æ“ä½œ</th>
                    <th>æ˜Ÿæ˜Ÿæ•°å­—å˜åŒ–</th>
                    <th>è¯´æ˜</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>æ¨¡æ‹Ÿè¿æ¥</td>
                    <td><span class="success">0 â†’ 20 â†’ 40 â†’ 50</span></td>
                    <td>å¾ªç¯è·å–æ‰€æœ‰é¡µé¢ï¼Œç´¯åŠ æ€»æ•°</td>
                </tr>
                <tr>
                    <td>ç‚¹å‡»æ˜Ÿæ˜Ÿ</td>
                    <td><span class="success">ä¸å˜</span></td>
                    <td>ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œä¸é‡å¤è¯·æ±‚</td>
                </tr>
                <tr>
                    <td>å†æ¬¡ç‚¹å‡»</td>
                    <td><span class="success">ä¸å˜</span></td>
                    <td>ç»§ç»­ä½¿ç”¨ç¼“å­˜æ•°æ®</td>
                </tr>
                <tr>
                    <td>è‡ªåŠ¨åˆ·æ–°</td>
                    <td><span class="success">ä¸å˜</span></td>
                    <td>è·å–ä¸­ï¼Œè·³è¿‡é‡å¤è·å–</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div style="text-align: center; margin-top: 30px; color: #888; font-size: 0.9em;">
        <p><strong>âœ… é€»è¾‘ä¿®æ­£å®Œæˆï¼</strong></p>
        <p>ä¿®å¤äº†é‡å¤ç´¯åŠ å’Œé‡å¤è¯·æ±‚çš„é—®é¢˜</p>
    </div>

    <script>
        // æ¨¡æ‹ŸçŠ¶æ€
        let isFetchingAll = false;
        let currentPage = 0;
        let totalQsoCount = 0;
        let qsoList = [];
        const pageSize = 20;

        // æ¨¡æ‹Ÿæ•°æ®ï¼ˆ3é¡µï¼Œå…±50æ¡ï¼‰
        const mockData = [
            { page: 0, count: 20 },
            { page: 1, count: 20 },
            { page: 2, count: 10 }
        ];

        function addLog(message) {
            const logOutput = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
            logOutput.insertBefore(logItem, logOutput.firstChild.nextSibling);

            // é™åˆ¶æ—¥å¿—æ¡æ•°
            while (logOutput.children.length > 50) {
                logOutput.removeChild(logOutput.lastChild);
            }
        }

        function updateBadge(count) {
            document.getElementById('badge-count').textContent = count;
        }

        function simulateConnect() {
            if (isFetchingAll) {
                addLog('<span style="color: #fbbf24;">âš ï¸ å·²åœ¨è·å–ä¸­ï¼Œè·³è¿‡</span>');
                return;
            }

            addLog('<span style="color: #4ade80;">ğŸ“¡ å¼€å§‹æ¨¡æ‹Ÿè¿æ¥...</span>');
            isFetchingAll = true;
            currentPage = 0;
            totalQsoCount = 0;
            qsoList = [];

            simulateFetchPage(0);
        }

        function simulateFetchPage(page) {
            addLog(`<span style="color: #60a5fa;">ğŸ“„ è·å– page ${page}...</span>`);

            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            setTimeout(() => {
                const data = mockData.find(d => d.page === page);
                if (!data) {
                    addLog('<span style="color: #f87171;">âŒ æ•°æ®ä¸ºç©ºï¼Œåœæ­¢è·å–</span>');
                    isFetchingAll = false;
                    return;
                }

                const count = data.count;
                totalQsoCount += count;
                qsoList = qsoList.concat(Array(count).fill({ page, count }));
                updateBadge(totalQsoCount);

                addLog(`<span style="color: #4ade80;">âœ“ Page ${page} è¿”å› ${count} æ¡ï¼Œç´¯è®¡ ${totalQsoCount} æ¡</span>`);

                // åˆ¤æ–­æ˜¯å¦ç»§ç»­
                if (count < pageSize) {
                    addLog(`<span style="color: #4ade80;">âœ… è·å–å®Œæˆï¼Œæ€»è®¡ ${totalQsoCount} æ¡</span>`);
                    isFetchingAll = false;
                } else {
                    addLog(`<span style="color: #fbbf24;">â° ç­‰å¾…60ç§’åç»§ç»­...</span>`);
                    currentPage++;
                    setTimeout(() => {
                        if (isFetchingAll) {
                            simulateFetchPage(currentPage);
                        }
                    }, 2000); // æ¼”ç¤ºç”¨2ç§’ä»£æ›¿60ç§’
                }
            }, 500);
        }

        function simulateClickBadge() {
            addLog('ğŸŒŸ ç‚¹å‡»æ˜Ÿæ˜Ÿå¾½ç« ');

            if (qsoList.length > 0) {
                addLog(`<span style="color: #4ade80;">âœ“ ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆ${qsoList.length}æ¡ï¼‰ï¼Œä¸é‡æ–°è¯·æ±‚</span>`);
                addLog('âœ“ æ˜Ÿæ˜Ÿæ•°å­—ä¸å˜');
            } else if (!isFetchingAll) {
                addLog('<span style="color: #60a5fa;">ğŸ“¡ æ— ç¼“å­˜æ•°æ®ï¼Œå¯åŠ¨å…¨é‡è·å–</span>');
                simulateConnect();
            } else {
                addLog('<span style="color: #fbbf24;">âš ï¸ æ­£åœ¨è·å–ä¸­ï¼Œè·³è¿‡</span>');
            }
        }

        function simulateRefresh() {
            addLog('ğŸ”„ æ¨¡æ‹Ÿè‡ªåŠ¨åˆ·æ–°');

            if (isFetchingAll) {
                addLog('<span style="color: #fbbf24;">âš ï¸ æ­£åœ¨è·å–ä¸­ï¼Œè·³è¿‡é‡å¤è·å–</span>');
            } else {
                addLog('<span style="color: #4ade80;">âœ“ è·å–å·²å®Œæˆæˆ–æœªå¼€å§‹ï¼Œé‡æ–°å¯åŠ¨å…¨é‡è·å–</span>');
                isFetchingAll = false;
                qsoList = [];
                simulateConnect();
            }
        }

        function simulateReset() {
            addLog('ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰çŠ¶æ€');
            isFetchingAll = false;
            currentPage = 0;
            totalQsoCount = 0;
            qsoList = [];
            updateBadge(0);
            addLog('<span style="color: #4ade80;">âœ“ çŠ¶æ€å·²é‡ç½®</span>');
        }
    </script>
</body>
</html>
