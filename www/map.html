<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸šä½™æ— çº¿ç”µæ¢…ç™»é»‘å¾·ç½‘æ ¼å®šä½ç³»ç»Ÿ | Maidenhead Locator GIS</title>
    <!-- æ›¿æ¢ä¸ºå›½å†… CDN (BootCDN) -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ - éšè—ä»¥å®ç°çº¯åœ°å›¾æ¨¡å¼ */
        .control-panel {
            display: none;
        }

        /* å³ä¾§åœ°å›¾ - å…¨å± */
        .map-container {
            flex: 1;
            position: relative;
            background: #000;
            width: 100%;
            height: 100vh;
        }

        h1 {
            color: #4dabf7;
            font-size: 24px;
            margin-bottom: 10px;
            border-bottom: 3px solid #1c7ed6;
            padding-bottom: 10px;
        }

        .subtitle {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: #252525;
            border-radius: 10px;
            border-left: 4px solid #1c7ed6;
        }

        .section h3 {
            color: #a5d8ff;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            background: #333;
            color: #fff;
            border: 2px solid #444;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #1c7ed6;
            background: #404040;
        }

        .coord-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #1c7ed6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: #1864ab;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        button.secondary {
            background: #2b8a3e;
            margin-top: 10px;
        }

        button.secondary:hover {
            background: #216f30;
        }

        .result-box {
            margin-top: 15px;
            padding: 15px;
            background: #1a2530;
            border-radius: 8px;
            border: 2px solid #1864ab;
            display: none;
        }

        .result-box.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .result-label {
            font-weight: 600;
            color: #aaa;
        }

        .result-value {
            color: #4dabf7;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .grid-display {
            font-size: 24px;
            color: #ff6b6b;
            text-align: center;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* å³ä¾§åœ°å›¾ - å…¨å± */
        .map-container {
            flex: 1;
            position: relative;
            background: #000;
            /* width: 100%; height already handled by flex parent, but let's be safe */
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* æ·±è‰²æ¨¡å¼åœ°å›¾æ»¤é•œ - é»˜è®¤åº”ç”¨äºæ™®é€šåœ°å›¾ */
        .map-dark-filter .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        .info-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(30, 30, 30, 0.95);
            color: #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000;
            max-width: 250px;
            font-size: 13px;
            border: 1px solid #444;
            transform: scale(0.8);
            transform-origin: top right;
        }

        .legend {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 3px;
        }

        .status-bar {
            position: absolute;
            bottom: 20px;
            left: 420px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: #eee;
            padding: 10px 20px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #444;
        }

        .error {
            color: #ff6b6b;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .error.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .control-panel {
                width: 100%;
                height: 40vh; /* å‡å°æ§åˆ¶é¢æ¿é«˜åº¦ */
                order: 2; /* åœ°å›¾åœ¨ä¸Šï¼Œæ§åˆ¶åœ¨ä¸‹ */
            }
            .map-container {
                height: 60vh;
                order: 1;
            }
            .status-bar {
                left: 20px;
                bottom: 20px; /* è°ƒæ•´ä½ç½® */
                display: none; /* ç§»åŠ¨ç«¯éšè—çŠ¶æ€æ ä»¥èŠ‚çœç©ºé—´ */
            }
        }

        /* å¼¹çª—ç¾åŒ– - åŠé€æ˜æ¯›ç»ç’ƒæ•ˆæœ */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: rgba(30, 30, 30, 0.85) !important;
            backdrop-filter: blur(8px);
            color: #e0e0e0 !important;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .leaflet-popup-content {
            margin: 8px 10px !important;
            line-height: 1.4 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <h1>ğŸ“¡ æ¢…ç™»é»‘å¾·ç½‘æ ¼å®šä½ç³»ç»Ÿ</h1>
            <div class="subtitle">Maidenhead Locator System GIS Tool</div>

            <!-- ç½‘æ ¼è§£ç  -->
            <div class="section">
                <h3>ğŸ” ç½‘æ ¼è§£ç  (Grid to Coordinates)</h3>
                <div class="input-group">
                    <label>è¾“å…¥ç½‘æ ¼åæ ‡ (å¦‚: OM16uc)</label>
                    <input type="text" id="gridInput" placeholder="OM16uc" maxlength="6">
                    <div class="error" id="gridError">è¯·è¾“å…¥æœ‰æ•ˆçš„6å­—ç¬¦ç½‘æ ¼åæ ‡ (å¦‚: OM16uc)</div>
                </div>
                <button onclick="decodeGrid()">è§£ç ä½ç½®</button>
                
                <div class="result-box" id="decodeResult">
                    <div class="grid-display" id="displayGrid"></div>
                    <div class="result-item">
                        <span class="result-label">ä¸­å¿ƒç»åº¦:</span>
                        <span class="result-value" id="centerLon"></span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ä¸­å¿ƒçº¬åº¦:</span>
                        <span class="result-value" id="centerLat"></span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ç²¾åº¦èŒƒå›´:</span>
                        <span class="result-value">~10Ã—5 km</span>
                    </div>
                    <button class="secondary" onclick="zoomToGrid()">å®šä½åˆ°åœ°å›¾</button>
                </div>
            </div>

            <!-- åæ ‡ç¼–ç  -->
            <div class="section">
                <h3>ğŸ“ åæ ‡ç¼–ç  (Coordinates to Grid)</h3>
                <div class="coord-inputs">
                    <div class="input-group">
                        <label>ç»åº¦ (Longitude)</label>
                        <input type="number" id="lonInput" placeholder="-180 ~ 180" step="0.0001">
                    </div>
                    <div class="input-group">
                        <label>çº¬åº¦ (Latitude)</label>
                        <input type="number" id="latIta2a0 placeholder="-90 ~ 90" tc4e9"0.0001">
                    </div>
                </div>ffd3b
                <div class="error" id="coordError">è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦å€¼</div>
                <button onclick="encodeCoordinates()">ç”Ÿæˆç½‘æ ¼</button>
                
                <div class="result-box" id="encodeResult">
                    <div class="result-item">
                        <span class="result-label">ç½‘æ ¼åæ ‡:</span>
                        <span class="result-value" id="generatedGrid" style="font-size: 18px; color: #d32f2f;"></span>
                    </div>
                    <button class="secondary" onclick="zoomToCoords()">åœ¨åœ°å›¾æ˜¾ç¤º</button>
                </div>
            </div>

            <!-- è¯´æ˜ -->
            <div class="section" style="background: #fff3cd; border-left-color: #ffc107;">
                <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
                <p style="font-size: 13px; line-height: 1.6; color: #856404;">
                    1. <b>ç½‘æ ¼è§£ç </b>: è¾“å…¥6å­—ç¬¦ç½‘æ ¼åæ ‡ (å¦‚ OM16uc)ï¼ŒæŸ¥çœ‹å¯¹åº”åœ°ç†ä½ç½®<br>6b6b
                    2. <b>åæ ‡ç¼–ç </b>: è¾“å…¥ç»çº¬åº¦ï¼Œç”Ÿæˆç½‘æ ¼åæ ‡<br>
                    3. <b>åœ°å›¾äº¤äº’</b>: ç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®è·å–ç½‘æ ¼åæ ‡<br>
                    <br>#ff6b6b
                    æ ¼å¼è¯´æ˜: AA00aa (åœº+æ–¹+å—)<br>
                    â€¢ ç²¾åº¦: ç»åº¦5â€² Ã— çº¬åº¦2.5â€² (çº¦10Ã—5å…¬é‡Œ)
                </p>
            </div>6b6b
        </div>

        <!-- å³ä¾§åœ°å›¾ -->
        <div class="map-container">
            <div id="map"></div>
            
            <div class="info-overlay">
                <strong>å½“æ—¥é€šè”äººæ•°</strong>
                <div id="currentGrid" style="font-size: 20px; color: #d32f2f; margin: 10px 0;">-</div>
            </div>

        </div>
    </div>

    <script>
        // åˆå§‹åŒ–åœ°å›¾
        const map = L.map('map', {
            zoomControl: false // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šé»˜è®¤éšè—ç¼©æ”¾æ§ä»¶ï¼Œå¯æŒ‰éœ€å¼€å¯
        }).setView([36.08, 103.67], 4); // é»˜è®¤è§†å›¾è°ƒæ•´ä¸ºä¸­å›½å…¨å¢ƒ
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // å›½å†…å‹å¥½åœ°å›¾æº
        const baseLayers = {
            "é«˜å¾·åœ°å›¾ (æš—é»‘)": L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                subdomains: ["1", "2", "3", "4"],
                attribution: 'Â© é«˜å¾·åœ°å›¾',
                className: 'dark-mode-layer' // æ ‡è¯†éœ€è¦æ»¤é•œ
            }),
            "GeoQ ç°è‰² (åŸç”Ÿ)": L.tileLayer('https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineCommunity/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Â© GeoQ æ™ºå›¾'
            }),
            "GeoQ æ·±è“ (åŸç”Ÿæ·±è‰²)": L.tileLayer('https://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Â© GeoQ æ™ºå›¾'
            }),
            "é«˜å¾·å«æ˜Ÿ": L.tileLayer('https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
                subdomains: ["1", "2", "3", "4"],
                attribution: 'Â© é«˜å¾·åœ°å›¾'
            })
        };

        // é»˜è®¤æ·»åŠ é«˜å¾·åœ°å›¾
        const defaultLayer = baseLayers["é«˜å¾·åœ°å›¾ (æš—é»‘)"];
        defaultLayer.addTo(map);
        
        // åˆå§‹åº”ç”¨æ»¤é•œ
        document.getElementById('map').classList.add('map-dark-filter');

        L.control.layers(baseLayers).addTo(map);

        // ç›‘å¬å›¾å±‚åˆ‡æ¢ï¼ŒåŠ¨æ€åº”ç”¨æ»¤é•œ
        map.on('baselayerchange', function(e) {
            const mapContainer = document.getElementById('map');
            if (e.name === "é«˜å¾·åœ°å›¾ (æš—é»‘)") {
                mapContainer.classList.add('map-dark-filter');
            } else {
                mapContainer.classList.remove('map-dark-filter');
            }
        });

        // å›¾å±‚ç»„ç®¡ç†
        let currentGridLayer = null;
        let currentMarker = null;
        let clickMarker = null;

        // çŠ¶æ€å˜é‡
        let currentGrid = null;
        let currentBounds = null;

        // ç½‘æ ¼è§£ç ç®—æ³• (6å­—ç¬¦æ ‡å‡†)
        function maidenheadDecode(grid) {
            if (!grid || grid.length < 4 || grid.length > 6) return null;
            
            grid = grid.toUpperCase();
            
            // ç¬¬ä¸€çº§: åœº (Field) - 20Â°Ã—10Â°
            const lonIdx = grid.charCodeAt(0) - 'A'.charCodeAt(0);
            const latIdx = grid.charCodeAt(1) - 'A'.charCodeAt(0);
            
            if (lonIdx < 0 || lonIdx > 17 || latIdx < 0 || latIdx > 17) return null;
            
            let lon = -180 + lonIdx * 20;
            let lat = -90 + latIdx * 10;
            let lonSize = 20;
            let latSize = 10;
            
            // ç¬¬äºŒçº§: æ–¹ (Square) - 2Â°Ã—1Â°
            if (grid.length >= 4) {
                const lonNum = parseInt(grid[2]);
                const latNum = parseInt(grid[3]);
                
                if (isNaN(lonNum) || isNaN(latNum)) return null;
                
                lon += lonNum * 2;
                lat += latNum * 1;
                lonSize = 2;
                latSize = 1;
            }
            
            // ç¬¬ä¸‰çº§: å— (Subsquare) - 5'Ã—2.5'
            if (grid.length >= 6) {
                const lonSub = grid.charCodeAt(4) - 'A'.charCodeAt(0);
                const latSub = grid.charCodeAt(5) - 'A'.charCodeAt(0);
                
                if (lonSub < 0 || lonSub > 23 || latSub < 0 || latSub > 23) return null;
                
                lon += lonSub * (2/24);
                lat += latSub * (1/24);
                lonSize = 2/24;
                latSize = 1/24;
            }
            
            return {
                grid: grid,
                bounds: [[lat, lon], [lat + latSize, lon + lonSize]],
                center: [lat + latSize/2, lon + lonSize/2],
                precision: grid.length === 6 ? 'high' : (grid.length === 4 ? 'medium' : 'low')
            };
        }

        // åæ ‡ç¼–ç ç®—æ³• (6å­—ç¬¦æ ‡å‡†)
        function maidenheadEncode(lat, lon) {
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) return null;
            
            // è°ƒæ•´åæ ‡åˆ°æ­£æ•°èŒƒå›´
            let adjLon = lon + 180;
            let adjLat = lat + 90;
            
            // ç¬¬ä¸€çº§: åœº
            const fieldLon = Math.floor(adjLon / 20);
            const fieldLat = Math.floor(adjLat / 10);
            let grid = String.fromCharCode('A'.charCodeAt(0) + fieldLon) +
                      String.fromCharCode('A'.charCodeAt(0) + fieldLat);
            
            adjLon %= 20;
            adjLat %= 10;
            
            // ç¬¬äºŒçº§: æ–¹
            const squareLon = Math.floor(adjLon / 2);
            const squareLat = Math.floor(adjLat / 1);
            grid += squareLon.toString() + squareLat.toString();
            
            adjLon %= 2;
            adjLat %= 1;
            
            // ç¬¬ä¸‰çº§: å— (è½¬æ¢ä¸ºåˆ†é’Ÿè®¡ç®—æ›´å‡†ç¡®)
            const subLon = Math.floor(adjLon / (2/24));
            const subLat = Math.floor(adjLat / (1/24));
            grid += String.fromCharCode('a'.charCodeAt(0) + subLon) +
                   String.fromCharCode('a'.charCodeAt(0) + subLat);
            
            return grid;
        }

        // è·å–åœ°ç†ä½ç½®åç§° (åå‘åœ°ç†ç¼–ç )
        async function resolveLocationName(lat, lon) {
            // å®šä¹‰åœ°ç†ç¼–ç æœåŠ¡åˆ—è¡¨ (ä¼˜å…ˆçº§ä»é«˜åˆ°ä½)
            const services = [
                // BigDataCloud (å›½å†…è®¿é—®è¾ƒç¨³å®šï¼Œæ— éœ€Key)
                {
                    name: 'BigDataCloud',
                    url: `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh-CN`,
                    parser: (data) => {
                        let parts = [];
                        if (data.city) parts.push(data.city);
                        if (data.locality && !parts.includes(data.locality)) parts.push(data.locality);
                        if (data.principalSubdivision && !parts.includes(data.principalSubdivision)) parts.push(data.principalSubdivision);
                        return parts.join(' ') || data.locality || 'æœªçŸ¥ä½ç½®';
                    }
                },
                // Nominatim OSM (å¤‡ç”¨ï¼Œå¯èƒ½è¢«å¢™)
                {
                    name: 'Nominatim',
                    url: `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14&addressdetails=1&accept-language=zh-CN`,
                    parser: (data) => {
                        const addr = data.address;
                        if (!addr) return null;
                        let parts = [];
                        if (addr.city) parts.push(addr.city);
                        else if (addr.county) parts.push(addr.county);
                        if (addr.district && !parts.includes(addr.district)) parts.push(addr.district);
                        if (addr.town) parts.push(addr.town);
                        else if (addr.suburb) parts.push(addr.suburb);
                        else if (addr.street) parts.push(addr.street);
                        if (addr.village) parts.push(addr.village);
                        else if (addr.neighbourhood) parts.push(addr.neighbourhood);
                        else if (addr.hamlet) parts.push(addr.hamlet);
                        return [...new Set(parts)].join(' ') || data.display_name.split(',')[0];
                    }
                }
            ];

            for (const service of services) {
                try {
                    console.log(`Trying geocoding service: ${service.name}...`);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000); // 3ç§’è¶…æ—¶

                    const response = await fetch(service.url, {
                        signal: controller.signal,
                        headers: service.name === 'Nominatim' ? { 'User-Agent': 'FMO-Audio-Controller/1.0' } : {}
                    });
                    clearTimeout(timeoutId);

                    if (response.ok) {
                        const data = await response.json();
                        const result = service.parser(data);
                        if (result && result !== 'æœªçŸ¥ä½ç½®') {
                            return result;
                        }
                    }
                } catch (e) {
                    console.warn(`${service.name} failed:`, e);
                    // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªæœåŠ¡
                }
            }

            return 'ä½ç½®æœåŠ¡ä¸å¯ç”¨';
        }

        // åœ¨åœ°å›¾ä¸Šç»˜åˆ¶ç½‘æ ¼
        function drawGridOnMap(gridData, color = '#d32f2f') {
            // æ¸…é™¤æ—§å›¾å±‚
            if (currentGridLayer) map.removeLayer(currentGridLayer);
            if (currentMarker) map.removeLayer(currentMarker);
            
            // ç»˜åˆ¶ç½‘æ ¼è¾¹ç•Œ
            currentGridLayer = L.rectangle(gridData.bounds, {
                color: color,
                weight: 3,
                fillColor: color,
                fillOpacity: 0.2,
                dashArray: '5, 5'
            }).addTo(map);
            
            // æ ‡è®°ä¸­å¿ƒç‚¹
            currentMarker = L.circleMarker(gridData.center, {
                radius: 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map);

            const uniqueId = `loc-${gridData.grid}-${Date.now()}`;
            const popupContent = `
                <div style="min-width:120px">
                    <div style="font-size:16px; font-weight:bold; color:#4dabf7; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:3px;">
                        ${gridData.grid}
                    </div>
                    <div id="${uniqueId}" style="font-size:12px; color:#e0e0e0; display:flex; align-items:start; line-height: 1.3;">
                        <span style="margin-right:4px; flex-shrink:0; font-size:11px;">ğŸ“</span>
                        <span class="loc-text">æ­£åœ¨å®šä½...</span>
                    </div>
                </div>
            `;

            currentMarker.bindPopup(popupContent).openPopup();
            
            resolveLocationName(gridData.center[0], gridData.center[1]).then(loc => {
                const el = document.getElementById(uniqueId);
                if (el) {
                    el.querySelector('.loc-text').textContent = loc;
                }
                // æ›´æ–° popup å†…å®¹ä»¥ä¾¿ä¸‹æ¬¡æ‰“å¼€æ—¶æ˜¾ç¤º
                const newContent = popupContent.replace('æ­£åœ¨å®šä½...', loc);
                currentMarker.setPopupContent(newContent);
            });
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            currentGrid = gridData.grid;
            currentBounds = gridData.bounds;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('currentGrid').textContent = gridData.grid;
            
            // é€‚åº”è§†å›¾
            map.fitBounds(gridData.bounds, { padding: [50, 50], maxZoom: 12 });
        }

        // è§£ç ç½‘æ ¼æŒ‰é’®
        function decodeGrid() {
            const input = document.getElementById('gridInput').value.trim();
            const errorEl = document.getElementById('gridError');
            const resultEl = document.getElementById('decodeResult');
            
            if (!/^[A-Ra-r]{2}[0-9]{2}[A-Za-z]{2}$/.test(input)) {
                errorEl.classList.add('active');
                resultEl.classList.remove('active');
                return;
            }
            
            errorEl.classList.remove('active');
            const data = maidenheadDecode(input);
            
            if (data) {
                document.getElementById('displayGrid').textContent = data.grid;
                document.getElementById('centerLon').textContent = data.center[1].toFixed(4) + 'Â°';
                document.getElementById('centerLat').textContent = data.center[0].toFixed(4) + 'Â°';
                resultEl.classList.add('active');
                
                drawGridOnMap(data);
                updateStatus(`å·²è§£ç ç½‘æ ¼: ${data.grid}`);
            }
        }

        // ç¼–ç åæ ‡æŒ‰é’®
        function encodeCoordinates() {
            const lon = parseFloat(document.getElementById('lonInput').value);
            const lat = parseFloat(document.getElementById('latInput').value);
            const errorEl = document.getElementById('coordError');
            const resultEl = document.getElementById('encodeResult');
            
            if (isNaN(lon) || isNaN(lat) || lon < -180 || lon > 180 || lat < -90 || lat > 90) {
                errorEl.classList.add('active');
                resultEl.classList.remove('active');
                return;
            }
            
            errorEl.classList.remove('active');
            const grid = maidenheadEncode(lat, lon);
            
            if (grid) {
                document.getElementById('generatedGrid').textContent = grid;
                resultEl.classList.add('active');
                
                const data = maidenheadDecode(grid);
                drawGridOnMap(data, '#28a745');
                updateStatus(`å·²ç¼–ç åæ ‡: ${grid}`);
            }
        }

        // ç¼©æ”¾åˆ°ç½‘æ ¼
        function zoomToGrid() {
            if (currentBounds) {
                map.fitBounds(currentBounds, { padding: [100, 100], maxZoom: 11 });
            }
        }

        // ç¼©æ”¾åˆ°åæ ‡
        function zoomToCoords() {
            zoomToGrid();
        }

        // ç›‘å¬å¤–éƒ¨æ¶ˆæ¯ (postMessage)
        window.addEventListener('message', function(event) {
            const msg = event.data;
            if (msg && msg.type === 'LOCATE_GRID' && msg.grid) {
                console.log('Received LOCATE_GRID:', msg.grid);
                document.getElementById('gridInput').value = msg.grid;
                decodeGrid(); // è§¦å‘è§£ç å’Œå®šä½
            }
        });
    </script>
</body>
</html>
                    ç»åº¦: ${lon.toFixed(4)}Â°<br>
                    <b>æ‰€åœ¨ç½‘æ ¼:</b> ${grid}
                `).openPopup();
                
                drawGridOnMap(data, '#2196f3');
                updateStatus(`ç‚¹å‡»ä½ç½®ç½‘æ ¼: ${grid}`);
                
                // æ›´æ–°è¾“å…¥æ¡†
                document.getElementById('gridInput').value = grid;
            }
        });

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(text) {
            const now = new Date().toLocaleTimeString();
            document.getElementById('statusText').textContent = `[${now}] ${text}`;
        }

        // ç¤ºä¾‹ï¼šé»˜è®¤æ˜¾ç¤ºOM16uc
        window.onload = function() {
            document.getElementById('gridInput').value = 'OM16uc';
            decodeGrid();
        };

        // å›è½¦é”®æ”¯æŒ
        document.getElementById('gridInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') decodeGrid();
        });
        
        document.getElementById('lonInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') encodeCoordinates();
        });
        
        document.getElementById('latInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') encodeCoordinates();
        });
    </script>
</body>
</html>